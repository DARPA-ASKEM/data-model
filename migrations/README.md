# Generic single-database configuration.

## Generating a migration for a new object in TDS

In order to generate a migration to add a new TDS object to the database and elastic search, a few steps must be followed. 

First, add your new object type into `tds/db/enums.py`. The object needs to be added in a few places as follows:

- Add it under `class ResourceType(str, Enum):` as `foo = "foo"`

If provenance is needed:

- Add it under `class ProvenanceType(str,Enum):` as `Foo = "Foo"`

Next, if you are establishing provenance for the object, add entries in a few more places:

- Add a `ProvenanceType` into `tds/schema/provenance.py`. This should be added to the `provenance_type_to_abbr` as `ProvenanceType.Foo: "Fo"` where the value in quotations is the first two letters of the objects name.
- Modify `tds/db/graph/search_provenance.py`, adding in any required function to search the provenance table for your provenance relation.
- Add the intended provenance relations to `graph_relations.json`

### Auto generate the migrations file

Next, run `make gen-migrations`. Enter in a description of your migration like "Adding foo object to TDS". This will autogenerate a file in `migrations/versions` that has some uuid as a file name. If provenance was modified, this file will have some autogenerated alembic commands to interface with postgresql and add entries to the provenance database.

To add an elastic search index for the new object, some manual entries will have to be made to this migrations file.

First, under `def upgrade()` add:
- `es.create_index(index_name=es.normalize_index("foo"), mapping={})`

where you can define a specific ES mapping object if needed.

Next under `def downgrade()` add:
- `es.remove_index(index_name=es.normalize_index("foo"))`

This is required for the rollback process.

### Running migrations

Finally start TDS. Then run `make run-migrations`. This command will apply your migrations to the TDS system, adding elastic search indices and modifying the relational database tables.


___Note___: If you are having troubles running the `make` command, try running `docker compose --env-file api.env run migrations` 
